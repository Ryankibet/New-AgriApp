{% load static %}

<footer id="footer" class="footer dark-background">

  <div class="footer-top">
    <div class="container">
      <div class="row gy-4 d-flex flex-wrap justify-content-between align-items-start text-center text-md-start">

        <!-- About Section -->
        <div class="col-lg-2 col-md-4 footer-about">
          <a href="/" class="logo d-flex align-items-center justify-content-center justify-content-md-start">
            <span class="sitename">AgriCulture</span>
          </a>
          <div class="footer-contact pt-2">
            <p>Majengo Homes</p>
            <p>Nyeri 1976-10100</p>
            <p class="mt-2"><strong>Phone:</strong> <span>+254702001001</span></p>
            <p><strong>Email:</strong> <span>agrifarms@gmail.com</span></p>
          </div>
        </div>

        <!-- Services -->
        <div class="col-lg-2 col-md-3 footer-links">
          <h4>Our Services</h4>
          <ul>
            <li><a href="#">Crop and Soil Management</a></li>
            <li><a href="#">Market Information</a></li>
            <li><a href="#">Fertiliser Application</a></li>
            <li><a href="#">Farm Management</a></li>
            <li><a href="#">Crop Management Advice</a></li>
          </ul>
        </div>

        <!-- Weather -->
        <div class="col-lg-2 col-md-4 footer-weather">
          <h4>ğŸŒ¦ï¸ Weather</h4>
          <div class="p-2" style="background:#f5fff4;border-radius:10px;box-shadow:0 4px 8px rgba(0,0,0,0.1);">
            <p id="weather-location" style="font-weight:600;">Fetching...</p>
            <p id="weather-temp" style="font-size:18px;color:#333;"></p>
            <p id="weather-desc" style="font-style:italic;color:#666;"></p>
          </div>
        </div>

        <!-- Daily Tip -->
        <div class="col-lg-2 col-md-4 footer-tip">
          <h4>ğŸŒ¿ Daily Tip</h4>
          <div class="p-2" style="background:#e8f5e9;border-radius:10px;box-shadow:0 4px 8px rgba(0,0,0,0.1);">
            <p id="tip-text" style="font-style:italic;color:#2e7d32;">Loading tip...</p>
          </div>
        </div>

        <!-- Mission -->
        <div class="col-lg-3 col-md-5 footer-mission">
          <h4>ğŸ¯ Mission</h4>
          <p style="font-size:14px;">
            Our mission is to provide accessible, user-friendly solutions that support farmers in making informed decisions,
            improving yields, and connecting to markets. We aim to promote sustainability, enhance agricultural efficiency,
            and empower communities through technology, education, and collaboration.
          </p>
        </div>

      </div>
    </div>
  </div>

  <div class="text-center mt-3">
    <div>Â© Copyright. All Rights Reserved</div>
    <div class="credits">Designed by Ryankibet</div>
  </div>

  <!-- ğŸ’¬ AI Farming Consultant -->
  <button id="chat-toggle">ğŸ’¬</button>

  <div id="chat-box">
    <div id="chat-header">AI Farming Consultant</div>
    <div id="chat-messages"></div>
    <div id="chat-input">
      <textarea id="question" rows="2" placeholder="Ask a question..."></textarea>
      <input type="file" id="image-upload" accept="image/*" style="display:none;">
      <button id="upload-btn" title="Upload image">ğŸ“·</button>
      <button id="send">â¤</button>
    </div>
  </div>

  <style>
    /* Floating Chat Button */
    #chat-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #2e7d32;
      color: white;
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 9999;
    }

    /* Chat Box */
    #chat-box {
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 320px;
      max-height: 420px;
      background-color: white;
      border: 1px solid #ccc;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      display: none;
      flex-direction: column;
      overflow: hidden;
      z-index: 10000;
    }

    #chat-header {
      background: #2e7d32;
      color: white;
      padding: 10px;
      text-align: center;
      font-weight: bold;
    }

    #chat-messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      font-size: 14px;
      max-height: 280px;
      display: flex;
      flex-direction: column;
    }

    #chat-messages div {
      margin: 6px 0;
      padding: 6px 10px;
      border-radius: 8px;
      max-width: 85%;
      line-height: 1.4;
    }

    #chat-messages div.user {
      background: #4CAF50;
      color: white;
      align-self: flex-end;
    }

    #chat-messages div.ai {
      background: #f9f9f9;
      color: #000;
      border: 1px solid #ddd;
      align-self: flex-start;
    }

    #chat-input {
      display: flex;
      border-top: 1px solid #ccc;
    }

    #chat-input textarea {
      flex: 1;
      border: none;
      padding: 10px;
      resize: none;
      outline: none;
    }

    #chat-input button {
      background: #2e7d32;
      color: white;
      border: none;
      padding: 10px 15px;
      cursor: pointer;
    }
  </style>

  <script>
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    const chatToggle = document.getElementById("chat-toggle");
    const chatBox = document.getElementById("chat-box");
    const sendBtn = document.getElementById("send");
    const uploadBtn = document.getElementById("upload-btn");
    const imageUpload = document.getElementById("image-upload");
    const messages = document.getElementById("chat-messages");

    let selectedImage = null;

    chatToggle.addEventListener("click", () => {
      chatBox.style.display = chatBox.style.display === "flex" ? "none" : "flex";
    });

    uploadBtn.addEventListener("click", () => imageUpload.click());

    imageUpload.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      selectedImage = file;
      const imgURL = URL.createObjectURL(file);
      messages.innerHTML += `<div class="user"><img src="${imgURL}" style="max-width:100%;border-radius:8px;margin:5px 0;"></div>`;
    });

    sendBtn.addEventListener("click", async () => {
      const question = document.getElementById("question").value.trim();
      if (!question && !selectedImage) return;

      if (question) messages.innerHTML += `<div class="user">ğŸ‘¨â€ğŸŒ¾ ${question}</div>`;
      document.getElementById("question").value = "";

      const formData = new FormData();
      if (question) formData.append("question", question);
      if (selectedImage) {
        formData.append("image", selectedImage);
        selectedImage = null;
      }

      try {
        const res = await fetch("/consult-ai/", {
          method: "POST",
          headers: { "X-CSRFToken": csrftoken },
          body: formData
        });
        const data = await res.json();
        messages.innerHTML += `<div class="ai">ğŸ¤– ${data.answer}</div>`;
      } catch (err) {
        messages.innerHTML += `<div class="ai" style="color:red;">âš ï¸ Could not reach AI</div>`;
      }
      messages.scrollTop = messages.scrollHeight;
    });
  </script>

</footer>

<!-- ğŸŒ¦ï¸ Weather + Daily Tip Scripts -->
<script>
  async function loadWeather() {
    const apiKey = "7ff8f4c4f1141e334fb396d05a8a6d6d"; // your OpenWeather API key
    const city = "Nairobi";
    const url = `https://api.openweathermap.org/data/2.5/weather?q=${city}&units=metric&appid=${apiKey}`;

    try {
      const res = await fetch(url);
      const data = await res.json();
      document.getElementById("weather-location").innerText = `ğŸ“ ${city}`;
      document.getElementById("weather-temp").innerText = `${Math.round(data.main.temp)}Â°C`;
      document.getElementById("weather-desc").innerText = data.weather[0].description;
    } catch {
      document.getElementById("weather-location").innerText = "Could not load weather ğŸ˜¢";
    }
  }
  loadWeather();

  // ğŸŒ¿ Random Daily Tip
  const tips = [
    "Rotate your crops to maintain soil fertility ğŸŒ¿",
    "Harvest early in the morning to preserve moisture ğŸŒ¤ï¸",
    "Check leaves for pest activity regularly ğŸ›",
    "Compost crop residues for natural fertilizer ğŸŒ±",
    "Use mulching to retain soil moisture ğŸ’§",
    "Irrigate evenly and avoid waterlogging ğŸš¿",
    "Add organic manure before planting season ğŸƒ",
    "Weed regularly to prevent nutrient competition ğŸŒ¾"
  ];
  document.getElementById("tip-text").innerText = tips[Math.floor(Math.random() * tips.length)];
</script>
